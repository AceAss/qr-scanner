<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner - Payment Verification</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .scanner-container {
            position: relative;
            margin-bottom: 30px;
        }

        #qr-reader {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .result-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .result-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .result-content.paid {
            border: 4px solid #4CAF50;
        }

        .result-content.not-found {
            border: 4px solid #f44336;
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .result-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-srn {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .result-status {
            font-size: 18px;
            font-weight: 600;
        }

        .paid .result-text {
            color: #4CAF50;
        }

        .not-found .result-text {
            color: #f44336;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .result-content {
                padding: 30px 20px;
            }

            .result-icon {
                font-size: 60px;
            }

            .result-text {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç QR Code Scanner</h1>
            <p>Scan QR codes to verify payment status</p>
        </div>

        <div class="scanner-container">
            <div id="qr-reader"></div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Checking payment status...</p>
        </div>

        <div class="error-message" id="error-message">
            <strong>Error:</strong> <span id="error-text"></span>
        </div>

        <div class="success-message" id="success-message">
            <strong>Success:</strong> <span id="success-text"></span>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="start-scan">Start Scanning</button>
            <button class="btn btn-secondary" id="stop-scan">Stop Scanning</button>
            <button class="btn btn-secondary" id="request-permission">Request Camera Permission</button>
            <button class="btn btn-secondary" id="clear-scanned">Clear Scanned Records</button>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="result-container" id="result-container">
        <div class="result-content" id="result-content">
            <div class="result-icon" id="result-icon">üîç</div>
            <div class="result-text" id="result-text">Scanning...</div>
            <div class="result-srn" id="result-srn"></div>
            <div class="result-status" id="result-status"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbztzes-_hTHObcG9udOPQFn05QnfD8bWO_nm1Tlh66rxOkkhI6IFfsNz_mvIOmDcDWQYg/exec';
        
        // Global variables
        let html5QrcodeScanner = null;
        let isScanning = false;
        let scannedSRNs = new Set(); // Track scanned SRNs to prevent duplicates

        // DOM elements
        const qrReader = document.getElementById('qr-reader');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const resultContainer = document.getElementById('result-container');
        const resultContent = document.getElementById('result-content');
        const resultIcon = document.getElementById('result-icon');
        const resultText = document.getElementById('result-text');
        const resultSrn = document.getElementById('result-srn');
        const resultStatus = document.getElementById('result-status');
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');

        // Initialize the scanner with optimized settings for high volume
        function initScanner() {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                {
                    fps: 30,                    // Higher FPS for faster scanning
                    qrbox: { width: 300, height: 300 }, // Larger scanning area
                    aspectRatio: 1.0,
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                    showTorchButtonIfSupported: true,  // Flashlight for better scanning
                    showZoomSliderIfSupported: true,   // Zoom control
                    defaultZoomValueIfSupported: 2,    // Default zoom level
                    useBarCodeDetectorIfSupported: true // Use native barcode detection
                },
                false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            isScanning = true;
            updateButtonStates();
        }

        // Handle successful QR code scan
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            // Extract SRN from the scanned data
            const srn = decodedText.trim();
            
            // Check if this SRN has already been scanned
            if (scannedSRNs.has(srn)) {
                showError(`QR Code already scanned! SRN: ${srn} has been used before.`);
                return; // Don't process duplicate scans
            }
            
            // Add SRN to scanned set and save to localStorage
            scannedSRNs.add(srn);
            saveScannedSRNs();
            
            // Stop scanning temporarily
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                isScanning = false;
                updateButtonStates();
            }

            // Show loading
            showLoading(true);
            hideMessages();
            
            // Make API request
            checkPaymentStatus(srn);
        }

        // Handle scan failure
        function onScanFailure(error) {
            // Don't show errors for normal scanning attempts
            console.log('Scan attempt failed:', error);
        }

        // Check payment status via API with timeout and retry logic
        async function checkPaymentStatus(srn) {
            const maxRetries = 3;
            const timeout = 5000; // 5 second timeout
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const url = `${API_BASE_URL}?SRN=${encodeURIComponent(srn)}`;
                    console.log(`API request attempt ${attempt}:`, url);
                    
                    // Create timeout promise
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    );
                    
                    // Race between fetch and timeout
                    const response = await Promise.race([
                        fetch(url),
                        timeoutPromise
                    ]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('API response:', data);
                    
                    // Show result
                    showResult(data, srn);
                    return; // Success, exit retry loop
                    
                } catch (error) {
                    console.error(`API request attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        // All retries failed
                        showError(`Failed to check payment status after ${maxRetries} attempts. Please try again.`);
                        resumeScanning();
                    } else {
                        // Wait before retry (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, attempt * 1000));
                    }
                }
            }
        }

        // Show result modal
        function showResult(apiData, srn) {
            showLoading(false);
            
            // Handle different response formats
            let isPaid = false;
            let resultText = '';
            let statusText = '';
            
            if (apiData.result === 'Paid') {
                isPaid = true;
                resultText = 'PAID';
                statusText = 'ALLOW ENTRY';
            } else if (apiData.result === 'Not Paid') {
                isPaid = false;
                resultText = 'NOT PAID';
                statusText = 'DENY ENTRY';
            } else if (apiData.result === 'Not Found') {
                isPaid = false;
                resultText = 'NOT FOUND';
                statusText = 'DENY ENTRY';
            } else {
                // Handle other cases
                isPaid = false;
                resultText = 'ERROR';
                statusText = 'DENY ENTRY';
            }
            
            // Update result content
            resultIcon.textContent = isPaid ? '‚úÖ' : '‚ùå';
            resultText.textContent = resultText;
            resultSrn.textContent = `SRN: ${srn}`;
            resultStatus.textContent = statusText;
            
            // Set styling
            resultContent.className = `result-content ${isPaid ? 'paid' : 'not-found'}`;
            
            // Show modal
            resultContainer.style.display = 'flex';
            
            // Auto-hide after 2 seconds for faster throughput
            setTimeout(() => {
                hideResult();
                resumeScanning();
            }, 2000);
        }

        // Hide result modal
        function hideResult() {
            resultContainer.style.display = 'none';
        }

        // Resume scanning
        function resumeScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                isScanning = true;
                updateButtonStates();
            }
        }

        // Show/hide loading
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-text').textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            document.getElementById('success-text').textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // Hide all messages
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Update button states
        function updateButtonStates() {
            startScanBtn.disabled = isScanning;
            stopScanBtn.disabled = !isScanning;
        }

        // Start scanning
        function startScanning() {
            if (!isScanning) {
                initScanner();
            }
        }

        // Stop scanning
        function stopScanning() {
            if (html5QrcodeScanner && isScanning) {
                html5QrcodeScanner.clear();
                isScanning = false;
                updateButtonStates();
            }
        }

        // Event listeners
        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);
        document.getElementById('request-permission').addEventListener('click', requestCameraPermission);
        document.getElementById('clear-scanned').addEventListener('click', clearScannedSRNs);

        // Load scanned SRNs from localStorage
        function loadScannedSRNs() {
            const stored = localStorage.getItem('scannedSRNs');
            if (stored) {
                scannedSRNs = new Set(JSON.parse(stored));
                console.log(`Loaded ${scannedSRNs.size} previously scanned SRNs`);
            }
        }

        // Save scanned SRNs to localStorage
        function saveScannedSRNs() {
            localStorage.setItem('scannedSRNs', JSON.stringify([...scannedSRNs]));
        }

        // Clear all scanned SRNs (for new event)
        function clearScannedSRNs() {
            scannedSRNs.clear();
            localStorage.removeItem('scannedSRNs');
            showSuccess('All scanned records cleared. Ready for new event!');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load previously scanned SRNs
            loadScannedSRNs();
            
            // Check if camera is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Camera not supported on this device. Please use a device with a camera.');
                return;
            }
            
            // Request camera permissions first
            requestCameraPermission();
        });

        // Request camera permission
        async function requestCameraPermission() {
            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Use back camera
                    } 
                });
                
                // Stop the stream immediately (we just needed permission)
                stream.getTracks().forEach(track => track.stop());
                
                // Permission granted, start scanning
                startScanning();
                
            } catch (error) {
                console.error('Camera permission denied:', error);
                showError('Camera permission is required to scan QR codes. Please allow camera access and refresh the page.');
            }
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isScanning) {
                stopScanning();
            } else if (!document.hidden && !isScanning) {
                startScanning();
            }
        });
    </script>
</body>
</html>
